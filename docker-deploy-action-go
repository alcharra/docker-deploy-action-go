#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail

RELEASE_VERSION="${RELEASE_VERSION:-}"
if [[ -z "$RELEASE_VERSION" ]]; then
  echo "❌ GITHUB_ACTION_REF is empty. Falling back to 'v1'."
  RELEASE_VERSION="v1"
fi

REPO="alcharra/docker-deploy-action-go"
GITHUB_ACTION_PATH="${GITHUB_ACTION_PATH%/}"

OS="$(uname -s | tr '[:upper:]' '[:lower:]')"
ARCH="$(uname -m)"
VARIANT=""

case "$ARCH" in
  x86_64 | amd64) ARCH="amd64" ;;
  i386 | i686)    ARCH="386" ;;
  armv5*)         ARCH="arm"; VARIANT="v5" ;;
  armv6*)         ARCH="arm"; VARIANT="v6" ;;
  armv7*)         ARCH="arm"; VARIANT="v7" ;;
  armv8* | aarch64) ARCH="arm64" ;;
  *) echo "❌ Unsupported architecture: $ARCH"; exit 1 ;;
esac

FILENAME="deploy-action_${OS}_${ARCH}"
[[ -n "$VARIANT" ]] && FILENAME="${FILENAME}${VARIANT}"
FILENAME="${FILENAME}_v${RELEASE_VERSION}"
[[ "$OS" == "windows" ]] && FILENAME="${FILENAME}.exe"

URL="https://github.com/${REPO}/releases/download/v${RELEASE_VERSION}/${FILENAME}"
TARGET="${GITHUB_ACTION_PATH}/${FILENAME}"

curl -fsSL --retry 5 --keepalive-time 2 "$URL" -o "$TARGET"
chmod +x "$TARGET"

"$TARGET" "$@"
rm -f "$TARGET"