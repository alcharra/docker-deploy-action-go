#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail


echo "DEBUG: GITHUB_ACTION_REF=${GITHUB_ACTION_REF:-<empty>}"
echo "DEBUG: GITHUB_ACTION_PATH=${GITHUB_ACTION_PATH:-<empty>}"

GITHUB_ACTION_PATH="${GITHUB_ACTION_PATH%/}"
RELEASE_VERSION="${GITHUB_ACTION_REF:-}"
BINARY_NAME="deploy-action_linux"

if [[ -z "$RELEASE_VERSION" ]]; then
  echo "‚ùå GITHUB_ACTION_REF is empty. Falling back to 'v1'."
  RELEASE_VERSION="v1"
fi

RELEASE_URL="https://github.com/alcharra/docker-deploy-action-go/releases/download/${RELEASE_VERSION}/${BINARY_NAME}"
TARGET="${GITHUB_ACTION_PATH}/${BINARY_NAME}"

curl -fsSL --retry 5 "${RELEASE_URL}" -o "${TARGET}"
chmod +x "${TARGET}"

"${TARGET}" "$@"
rm -f "${TARGET}"